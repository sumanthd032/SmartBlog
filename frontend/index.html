<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartBlog - Your AI-Powered Blog</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="/" class="text-3xl font-bold text-gray-900">SmartBlog</a>
            <div id="auth-links" class="space-x-2 flex items-center"></div>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-8">
        <div class="mb-8">
            <input type="search" id="search-input" placeholder="🔍 Search posts..." class="w-full p-4 text-lg border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
        </div>
        <h2 class="text-2xl font-semibold mb-6">Latest Posts</h2>
        <div id="posts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const authLinksContainer = document.getElementById('auth-links');
            const token = localStorage.getItem('accessToken');

            if (token) {
                authLinksContainer.innerHTML = `
                    <a href="/dashboard.html" class="text-gray-600 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">Dashboard</a>
                    <a href="/profile.html" class="text-gray-600 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">My Profile</a>
                    <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">Logout</button>
                `;
                document.getElementById('logout-btn').addEventListener('click', () => {
                    localStorage.removeItem('accessToken');
                    Toastify({ text: "You have been logged out.", style: { background: "black" } }).showToast();
                    setTimeout(() => window.location.reload(), 1500);
                });
            } else {
                authLinksContainer.innerHTML = `
                    <a href="/login.html" class="text-gray-600 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">Login</a>
                    <a href="/register.html" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Register</a>
                `;
            }

            const postsContainer = document.getElementById('posts-container');
            const searchInput = document.getElementById('search-input');
            let debounceTimer;

            const fetchAndRenderPosts = async (searchTerm = '') => {
                postsContainer.innerHTML = '<p class="col-span-full text-center">Loading posts...</p>';
                let url = '/api/posts/';
                if (searchTerm) url += `?search=${encodeURIComponent(searchTerm)}`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const posts = await response.json();
                    postsContainer.innerHTML = '';
                    if (posts.length === 0) {
                        postsContainer.innerHTML = '<p class="col-span-full text-center">No posts found.</p>';
                        return;
                    }
                    posts.forEach(post => {
                        const postElement = document.createElement('div');
                        postElement.className = 'bg-white rounded-lg shadow-md overflow-hidden transform hover:-translate-y-1 transition-transform';
                        const summary = post.content.substring(0, 120) + (post.content.length > 120 ? '...' : '');
                        postElement.innerHTML = `
                            <div class="p-6">
                                <a href="/post.html?id=${post.id}" class="block">
                                    <h3 class="text-xl font-bold mb-2 text-gray-900 hover:text-blue-600">${post.title}</h3>
                                </a>
                                <p class="text-gray-600 mb-4 h-20">${summary}</p>
                                <div class="flex items-center text-sm text-gray-500 pt-4 border-t border-gray-100">
                                    <span>by <a href="/user.html?username=${post.author.username}" class="font-medium hover:underline text-blue-600">${post.author.username}</a></span>
                                </div>
                            </div>
                        `;
                        postsContainer.appendChild(postElement);
                    });
                } catch (error) {
                    postsContainer.innerHTML = `<p class="col-span-full text-center text-red-500">${error.message}</p>`;
                }
            };

            searchInput.addEventListener('keyup', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => fetchAndRenderPosts(searchInput.value.trim()), 300);
            });
            fetchAndRenderPosts();
        });
    </script>
</body>
</html>
