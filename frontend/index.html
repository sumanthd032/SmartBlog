<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartBlog</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">

    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-900">SmartBlog</h1>
            <div id="auth-links" class="space-x-4">
                </div>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-8">
        
        <div class="mb-8">
            <input 
                type="search" 
                id="search-input" 
                placeholder="ðŸ” Search posts by keyword..." 
                class="w-full p-4 text-lg border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition-colors"
            >
        </div>

        <h2 class="text-2xl font-semibold mb-6">Latest Posts</h2>
        
        <div id="posts-container" class="space-y-6">
            </div>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const authLinksContainer = document.getElementById('auth-links');
            const token = localStorage.getItem('accessToken');

            if (token) {
                // User is logged in
                authLinksContainer.innerHTML = `
                    <a href="/dashboard.html" class="text-gray-600 hover:text-gray-900">My Dashboard</a>
                    <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">Logout</button>
                `;

                document.getElementById('logout-btn').addEventListener('click', () => {
                    localStorage.removeItem('accessToken');
                    window.location.reload(); // Refresh the page
                });
            } else {
                // User is not logged in
                authLinksContainer.innerHTML = `
                    <a href="/login.html" class="text-gray-600 hover:text-gray-900">Login</a>
                    <a href="/register.html" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Register</a>
                `;
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const postsContainer = document.getElementById('posts-container');
            const searchInput = document.getElementById('search-input');
            let debounceTimer;

            // --- Function to Fetch and Render Posts ---
            const fetchAndRenderPosts = async (searchTerm = '') => {
                postsContainer.innerHTML = '<p>Loading posts...</p>';
                
                let url = '/api/posts/';
                if (searchTerm) {
                    url += `?search=${encodeURIComponent(searchTerm)}`;
                }

                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Network response was not ok');
                    
                    const posts = await response.json();
                    postsContainer.innerHTML = ''; 

                    if (posts.length === 0) {
                        postsContainer.innerHTML = '<p>No posts found. Try a different search!</p>';
                        return;
                    }

                    posts.forEach(post => {
                        const postElement = document.createElement('div');
                        postElement.className = 'bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300';
                        
                        const postDate = new Date(post.created_at).toLocaleDateString('en-US', {
                            year: 'numeric', month: 'long', day: 'numeric'
                        });

                        const summary = post.content.substring(0, 150) + (post.content.length > 150 ? '...' : '');

                        postElement.innerHTML = `
                            <a href="/post.html?id=${post.id}" class="block">
                                <h3 class="text-xl font-bold mb-2 hover:text-blue-600">${post.title}</h3>
                            </a>
                            <p class="text-gray-600 mb-4">${summary}</p>
                            <div class="flex items-center text-sm text-gray-500">
                                <span>by User ID: ${post.author_id}</span>
                                <span class="mx-2">&bull;</span>
                                <span>${postDate}</span>
                            </div>
                        `;
                        postsContainer.appendChild(postElement);
                    });
                } catch (error) {
                    console.error('Error fetching posts:', error);
                    postsContainer.innerHTML = '<p class="text-red-500">Failed to load posts.</p>';
                }
            };

            // --- Event Listener for the Search Input ---
            searchInput.addEventListener('keyup', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    const searchTerm = searchInput.value.trim();
                    fetchAndRenderPosts(searchTerm);
                }, 300); 
            });

            // --- Initial Load ---
            fetchAndRenderPosts();
        });
    </script>

</body>
</html>